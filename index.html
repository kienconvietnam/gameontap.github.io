<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game √în T·∫≠p ƒê·ªãa L√≠ 12 (ƒê·ªìng ƒê·ªôi)</title>
    <!-- T·∫£i Tailwind CSS ƒë·ªÉ t·∫°o giao di·ªán ƒë·∫πp v√† responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- T·∫£i Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // C·∫•u h√¨nh Firebase (L·∫•y t·ª´ bi·∫øn to√†n c·ª•c)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (Object.keys(firebaseConfig).length > 0) {
            window.app = initializeApp(firebaseConfig);
            window.db = getFirestore(window.app);
            window.auth = getAuth(window.app);
            setLogLevel('debug'); // B·∫≠t log cho Firebase
            
            // H√†m ƒëƒÉng nh·∫≠p
            async function initializeAuth() {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(window.auth, initialAuthToken);
                    } else {
                        await signInAnonymously(window.auth);
                    }
                } catch (error) {
                    console.error("Firebase Auth Error:", error);
                    // D√π l·ªói v·∫´n c·ªë g·∫Øng ti·∫øp t·ª•c ƒë·ªÉ l·∫•y UID n·∫øu c√≥ th·ªÉ
                }

                onAuthStateChanged(window.auth, (user) => {
                    window.userId = user ? user.uid : crypto.randomUUID();
                    console.log("User initialized. UID:", window.userId);
                    // B·∫Øt ƒë·∫ßu game sau khi c√≥ UID
                    if (window.onAuthReady) window.onAuthReady();
                });
            }
            initializeAuth();
        } else {
            console.error("Firebase configuration not found. Game will run in simulated mode.");
            window.userId = crypto.randomUUID();
            window.db = null;
            if (window.onAuthReady) window.onAuthReady();
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdf4; /* Light Emerald */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            width: 100%;
            background: linear-gradient(135deg, #ecfccb 0%, #d9f99d 100%); /* Light Green Gradient */
            border-radius: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            padding: 30px;
            border: 4px solid #4ade80; /* Emerald 400 */
        }
        .option-button {
            transition: all 0.3s ease;
            transform: scale(1);
            position: relative;
            overflow: hidden;
            text-align: left;
            padding-left: 20px;
        }
        .option-button:hover:not(.disabled):not(.correct):not(.incorrect) {
            background-color: #6ee7b7; /* Emerald 300 */
            transform: scale(1.02);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .option-button.correct {
            background-color: #10b981; /* Green 500 */
            color: white;
            animation: pulse-correct 0.5s 3;
        }
        .option-button.incorrect {
            background-color: #ef4444; /* Red 500 */
            color: white;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% {transform: translateX(0) scale(1);}
            20%, 60% {transform: translateX(-5px) scale(1);}
            40%, 80% {transform: translateX(5px) scale(1);}
        }
        @keyframes pulse-correct {
            0% {box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);}
            70% {box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);}
            100% {box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);}
        }
        .disabled {
            pointer-events: none;
            opacity: 0.8;
        }
        
        #bonus-game {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .star {
            position: absolute;
            font-size: 3rem;
            cursor: pointer;
            user-select: none;
            color: gold;
            animation: fall linear forwards;
            text-shadow: 0 0 10px rgba(255, 255, 0, 0.8);
        }
        @keyframes fall {
            0% { transform: translateY(-100px) scale(1); opacity: 1; }
            100% { transform: translateY(100vh) scale(0.5); opacity: 0; }
        }
        .team-score-box {
            border: 2px solid;
            padding: 8px 12px;
            border-radius: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .team-xanh { border-color: #3b82f6; background-color: #eff6ff; color: #1e40af; }
        .team-vang { border-color: #f59e0b; background-color: #fffbeb; color: #b45309; }
        .team-label { font-size: 0.75rem; font-weight: 600; }
        .team-score { font-size: 1.5rem; font-weight: 800; }
    </style>
</head>
<body>

<div class="container">
    <h1 class="text-3xl md:text-4xl font-extrabold text-center text-gray-800 mb-6">
        <span class="text-green-600">ƒê·ªãa L√≠ 12</span> - Game ƒê·ªìng ƒê·ªôi
    </h1>
    
    <!-- M√†n h√¨nh ch·ªçn ƒë·ªôi -->
    <div id="team-screen" class="text-center p-8 space-y-6">
        <h2 class="text-2xl font-bold text-gray-700">Ch·ªçn ƒê·ªôi C·ªßa B·∫°n</h2>

        <!-- TH√îNG TIN PH√íNG HI·ªÜN T·∫†I -->
        <div class="space-y-2 p-4 bg-green-50/70 rounded-xl border border-green-200">
            <h3 class="font-bold text-green-700">Ph√≤ng hi·ªán t·∫°i:</h3>
            <p class="text-sm text-gray-600">
                ID Ph√≤ng: <span id="room-id" class="font-mono text-sm break-all font-bold text-green-800">ƒêang t·∫£i...</span> 
                <span onclick="copyRoomLink()" class="cursor-pointer text-blue-500 hover:text-blue-700 ml-1 font-semibold">
                    [Sao ch√©p Link]
                </span>
            </p>
            <p id="copy-feedback" class="text-xs text-green-500 font-semibold mt-1 opacity-0 transition duration-300"></p>
        </div>
        
        <!-- √î T·∫†O PH√íNG M·ªöI -->
        <button onclick="createAndRedirectToNewRoom()" class="w-full py-3 px-6 bg-red-500 text-white font-bold rounded-xl shadow-lg hover:bg-red-600 transition duration-200 transform hover:scale-105">
            T·∫°o Ph√≤ng M·ªõi Ng·∫´u Nhi√™n
        </button>

        <div class="text-lg font-bold text-gray-500">--- HO·∫∂C ---</div>

        <!-- √î NH·∫¨P ID PH√íNG ƒê·ªÇ V√ÄO -->
        <div id="join-room-section" class="flex flex-col gap-2">
            <input type="text" id="join-room-input" placeholder="Nh·∫≠p ID ph√≤ng c·ªßa b·∫°n b√® (v√≠ d·ª•: room-abc123)"
                   class="w-full p-3 border-2 border-green-500 rounded-lg focus:border-green-600 focus:ring-1 focus:ring-green-600">
            <button onclick="joinRoomById()" class="w-full py-3 px-6 bg-blue-500 text-white font-bold rounded-xl shadow-md hover:bg-blue-600 transition duration-200">
                V√†o Ph√≤ng
            </button>
            <p id="join-feedback" class="text-sm text-red-500 font-semibold mt-1 h-5"></p>
        </div>

        <div class="text-lg font-bold text-gray-500">--- V√Ä CH·ªåN ƒê·ªòI ---</div>
        
        <div class="flex flex-col md:flex-row gap-4 justify-center">
            <button onclick="joinTeam('teamA')" class="py-4 px-6 team-xanh shadow-lg hover:shadow-xl transition duration-200 w-full md:w-1/2">
                <span class="text-xl">üîµ ƒê·ªôi Xanh</span>
                <p class="text-sm font-normal mt-1">H·ª£p l·ª±c c√πng ƒë·ªìng ƒë·ªôi</p>
            </button>
            <button onclick="joinTeam('teamB')" class="py-4 px-6 team-vang shadow-lg hover:shadow-xl transition duration-200 w-full md:w-1/2">
                <span class="text-xl">üü° ƒê·ªôi V√†ng</span>
                <p class="text-sm font-normal mt-1">C√πng nhau chinh ph·ª•c ki·∫øn th·ª©c</p>
            </button>
        </div>
        <button id="start-button" onclick="startGameInCurrentRoom()" class="mt-8 py-3 px-6 bg-green-600 text-white font-bold rounded-xl shadow-lg hover:bg-green-700 transition duration-200 transform hover:scale-105 hidden">
            Admin: B·∫Øt ƒê·∫ßu L·∫°i Game/X√°o Tr·ªôn C√¢u H·ªèi (Ph√≤ng Hi·ªán T·∫°i)
        </button>
    </div>

    <!-- M√†n h√¨nh Quiz -->
    <div id="quiz-screen" class="space-y-6 hidden">
        <!-- Khu v·ª±c Leaderboard v√† th√¥ng tin -->
        <div class="flex justify-between items-center p-3 bg-white/70 rounded-xl shadow-inner border border-green-300">
            <span class="text-lg font-semibold text-gray-700">C√¢u: <span id="question-index">1</span>/<span id="total-questions"></span></span>
            
            <div id="leaderboard" class="flex gap-4">
                <div id="score-teamA" class="team-score-box team-xanh">
                    <span class="team-label mr-2">XANH:</span>
                    <span class="team-score">0</span>
                </div>
                <div id="score-teamB" class="team-score-box team-vang">
                    <span class="team-label mr-2">V√ÄNG:</span>
                    <span class="team-score">0</span>
                </div>
            </div>
        </div>

        <!-- Khu v·ª±c c√¢u h·ªèi -->
        <div class="bg-white p-6 rounded-xl shadow-lg border border-green-400">
            <p id="question-text" class="text-xl font-bold text-gray-900 mb-4 text-center"></p>
            <div id="options-container" class="space-y-3">
                <!-- C√°c n√∫t ƒë√°p √°n s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y b·∫±ng JS -->
            </div>
            <div id="answered-by-team" class="text-center mt-3 text-sm font-medium text-gray-500 hidden">
                ƒê·ªôi <span id="answering-team-name" class="font-bold"></span> ƒë√£ tr·∫£ l·ªùi c√¢u n√†y!
            </div>
        </div>
        
        <!-- Khu v·ª±c ph·∫£n h·ªìi -->
        <div id="feedback-message" class="text-center text-xl font-bold h-8"></div>
        
        <!-- N√∫t ti·∫øp t·ª•c (Ch·ªâ admin ho·∫∑c sau khi c√¢u h·ªèi ƒë∆∞·ª£c gi·∫£i) -->
        <button id="next-button" 
                class="w-full py-3 px-4 bg-yellow-500 text-white font-bold rounded-xl shadow-md hover:bg-yellow-600 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                disabled
                onclick="nextQuestion()">
            Ti·∫øp t·ª•c C√¢u h·ªèi
        </button>
    </div>

    <!-- M√†n h√¨nh k·∫øt th√∫c -->
    <div id="end-screen" class="hidden text-center p-8 space-y-6">
        <h2 class="text-3xl font-extrabold text-green-700">üèÜ K·∫æT TH√öC TR·∫¨N ƒê·∫§U üèÜ</h2>
        <p class="text-2xl text-gray-800">
            ƒê·ªôi <span id="winning-team" class="text-4xl font-bold text-red-600"></span> ƒë√£ gi√†nh chi·∫øn th·∫Øng!
        </p>
        <p id="result-message" class="text-lg text-gray-600"></p>
        <button onclick="createAndRedirectToNewRoom()" class="py-3 px-6 bg-green-600 text-white font-bold rounded-xl shadow-lg hover:bg-green-700 transition duration-200 transform hover:scale-105">
            T·∫°o Ph√≤ng M·ªõi
        </button>
    </div>
</div>

<!-- MINI GAME (Tr√≤ Ch∆°i Ph·ª•) -->
<div id="bonus-game">
    <div class="text-center p-8 bg-yellow-100 rounded-xl shadow-2xl border-4 border-yellow-400 transform scale-110">
        <h3 class="text-3xl font-bold text-yellow-700 mb-4">‚≠ê TH∆Ø·ªûNG ƒêI·ªÇM B√ç M·∫¨T! ‚≠ê</h3>
        <p class="text-lg text-gray-700">Nhanh tay b·∫•m v√†o üí∞ ƒë·ªÉ nh·∫≠n th√™m ƒëi·ªÉm th∆∞·ªüng cho ƒë·ªôi!</p>
    </div>
</div>

<script type="module">
    import { doc, setDoc, onSnapshot, updateDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // --- KH·ªûI T·∫†O ID PH√íNG ƒê·ªòNG T·ª™ URL ---
    const DEFAULT_ROOM_ID = 'default_room_geo_quiz';
    function getSessionIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        // ∆Øu ti√™n l·∫•y t·ª´ URL, n·∫øu kh√¥ng c√≥, d√πng ID m·∫∑c ƒë·ªãnh.
        return urlParams.get('room') || DEFAULT_ROOM_ID;
    }
    const SESSION_ID = getSessionIdFromUrl(); 
    // ------------------------------------

    let myTeamId = null; // teamA ho·∫∑c teamB
    let bonusGameActive = false;
    let bonusStarCount = 0;
    
    // C·∫•u h√¨nh c√°c c√¢u h·ªèi (C·ªë ƒë·ªãnh trong code)
    const questions = [
        { topic: "B√†i 6: Bi·ªÉn ƒê√¥ng v√† h·∫£i ƒë·∫£o", question: "Hai qu·∫ßn ƒë·∫£o l·ªõn thu·ªôc ch·ªß quy·ªÅn Vi·ªát Nam tr√™n Bi·ªÉn ƒê√¥ng l√†?", options: ["Qu·∫ßn ƒë·∫£o C√°t B√† v√† C√¥n ƒê·∫£o", "Qu·∫ßn ƒë·∫£o Tr∆∞·ªùng Sa v√† C√¥n ƒê·∫£o", "Qu·∫ßn ƒë·∫£o Ho√†ng Sa v√† Tr∆∞·ªùng Sa", "Qu·∫ßn ƒë·∫£o L√Ω S∆°n v√† Th·ªï Chu"], answer: "Qu·∫ßn ƒë·∫£o Ho√†ng Sa v√† Tr∆∞·ªùng Sa" },
        { topic: "B√†i 4: N∆∞·ªõc tr√™n l√£nh th·ªï Vi·ªát Nam", question: "M·∫°ng l∆∞·ªõi s√¥ng ng√≤i n∆∞·ªõc ta c√≥ ƒë·∫∑c ƒëi·ªÉm n·ªïi b·∫≠t l√†?", options: ["Ng·∫Øn, d·ªëc, l∆∞u l∆∞·ª£ng n∆∞·ªõc ·ªïn ƒë·ªãnh", "D√†i, √≠t ph√π sa, l∆∞u l∆∞·ª£ng n∆∞·ªõc theo m√πa", "Ng·∫Øn, d·ªëc, nhi·ªÅu n∆∞·ªõc v√† gi√†u ph√π sa", "√çt s√¥ng, ch·ªß y·∫øu l√† s√¥ng l·ªõn"], answer: "Ng·∫Øn, d·ªëc, nhi·ªÅu n∆∞·ªõc v√† gi√†u ph√π sa" },
        { topic: "B√†i 1: V·ªã tr√≠ ƒë·ªãa l√≠ v√† ph·∫°m vi l√£nh th·ªï", question: "ƒêi·ªÉm c·ª±c B·∫Øc ph·∫ßn ƒë·∫•t li·ªÅn n∆∞·ªõc ta n·∫±m ·ªü vƒ© ƒë·ªô n√†o?", options: ["23¬∞23' B·∫Øc", "8¬∞34' B·∫Øc", "102¬∞10' ƒê√¥ng", "109¬∞24' ƒê√¥ng"], answer: "23¬∞23' B·∫Øc" },
        { topic: "B√†i 3: Kh√≠ h·∫≠u Vi·ªát Nam", question: "Gi√≥ m√πa ƒê√¥ng B·∫Øc ho·∫°t ƒë·ªông m·∫°nh m·∫Ω nh·∫•t v√†o th·ªùi gian n√†o v√† g√¢y ra th·ªùi ti·∫øt g√¨ ·ªü mi·ªÅn B·∫Øc?", options: ["H·∫°, kh√¥ n√≥ng", "Xu√¢n, m∆∞a ph√πn", "ƒê√¥ng, r√©t ƒë·∫≠m, r√©t h·∫°i", "Thu, m√°t m·∫ª"], answer: "ƒê√¥ng, r√©t ƒë·∫≠m, r√©t h·∫°i" },
        { topic: "B√†i 2: ƒê·ªãa h√¨nh Vi·ªát Nam", question: "H∆∞·ªõng n√∫i ch√≠nh c·ªßa ƒë·ªãa h√¨nh n∆∞·ªõc ta l√† g√¨?", options: ["V√≤ng cung v√† ƒê√¥ng - T√¢y", "B·∫Øc - Nam v√† T√¢y B·∫Øc - ƒê√¥ng Nam", "V√≤ng cung v√† T√¢y B·∫Øc - ƒê√¥ng Nam", "ƒê√¥ng - T√¢y v√† B·∫Øc - Nam"], answer: "T√¢y B·∫Øc - ƒê√¥ng Nam v√† V√≤ng cung" },
        { topic: "B√†i 3: Kh√≠ h·∫≠u Vi·ªát Nam", question: "ƒê·∫∑c ƒëi·ªÉm c∆° b·∫£n c·ªßa kh√≠ h·∫≠u Vi·ªát Nam l√† g√¨?", options: ["√în ƒë·ªõi gi√≥ m√πa", "C·∫≠n nhi·ªát ƒë·ªõi gi√≥ m√πa", "Nhi·ªát ƒë·ªõi ·∫©m gi√≥ m√πa", "Kh√≠ h·∫≠u l·ª•c ƒë·ªãa"], answer: "Nhi·ªát ƒë·ªõi ·∫©m gi√≥ m√πa" },
        { topic: "B√†i 5: Th·ªï nh∆∞·ª°ng v√† sinh v·∫≠t", question: "Lo·∫°i ƒë·∫•t chi·∫øm t·ªâ l·ªá l·ªõn nh·∫•t trong t·ªïng di·ªán t√≠ch ƒë·∫•t t·ª± nhi√™n c·ªßa n∆∞·ªõc ta l√†?", options: ["ƒê·∫•t ph√π sa", "ƒê·∫•t x√°m", "ƒê·∫•t feralit", "ƒê·∫•t m√πn tr√™n n√∫i cao"], answer: "ƒê·∫•t feralit" },
        { topic: "B√†i 2: ƒê·ªãa h√¨nh Vi·ªát Nam", question: "ƒê·ªãa h√¨nh ƒë·ªìi n√∫i chi·∫øm bao nhi√™u ph·∫ßn trƒÉm di·ªán t√≠ch l√£nh th·ªï n∆∞·ªõc ta?", options: ["D∆∞·ªõi 50%", "Kho·∫£ng 65%", "Kho·∫£ng 85%", "Tr√™n 90%"], answer: "Kho·∫£ng 85%" },
        { topic: "B√†i 1: V·ªã tr√≠ ƒë·ªãa l√≠ v√† ph·∫°m vi l√£nh th·ªï", question: "Vi·ªát Nam c√≥ bao nhi√™u t·ªânh v√† th√†nh ph·ªë tr·ª±c thu·ªôc Trung ∆∞∆°ng gi√°p bi·ªÉn?", options: ["28", "32", "24", "40"], answer: "28" },
        { topic: "B√†i 6: Bi·ªÉn ƒê√¥ng v√† h·∫£i ƒë·∫£o", question: "N·ªôi th·ªßy l√† v√πng bi·ªÉn ƒë∆∞·ª£c t√≠nh t·ª´ ƒë√¢u?", options: ["ƒê∆∞·ªùng c∆° s·ªü", "ƒê∆∞·ªùng m√©p n∆∞·ªõc bi·ªÉn th·∫•p nh·∫•t", "ƒê∆∞·ªùng ranh gi·ªõi ngo√†i c·ªßa l√£nh h·∫£i", "ƒê∆∞·ªùng ranh gi·ªõi ngo√†i c·ªßa v√πng ƒë·∫∑c quy·ªÅn kinh t·∫ø"], answer: "ƒê∆∞·ªùng c∆° s·ªü" }
    ];

    // L·∫•y c√°c ph·∫ßn t·ª≠ DOM
    const questionIndexEl = document.getElementById('question-index');
    const totalQuestionsEl = document.getElementById('total-questions');
    const questionTextEl = document.getElementById('question-text');
    const optionsContainer = document.getElementById('options-container');
    const feedbackMessageEl = document.getElementById('feedback-message');
    const nextButton = document.getElementById('next-button');
    const quizScreen = document.getElementById('quiz-screen');
    const endScreen = document.getElementById('end-screen');
    const teamScreen = document.getElementById('team-screen');
    const scoreTeamAEl = document.querySelector('#score-teamA .team-score');
    const scoreTeamBEl = document.querySelector('#score-teamB .team-score');
    const answeredByTeamEl = document.getElementById('answered-by-team');
    const answeringTeamNameEl = document.getElementById('answering-team-name');
    const winningTeamEl = document.getElementById('winning-team');
    const resultMessageEl = document.getElementById('result-message');
    const bonusGameEl = document.getElementById('bonus-game');
    const startButton = document.getElementById('start-button');
    const roomIdEl = document.getElementById('room-id'); 
    const copyFeedbackEl = document.getElementById('copy-feedback');
    const joinFeedbackEl = document.getElementById('join-feedback');
    
    let currentGameState = null;

    // --- UTILITY FUNCTION ---
    
    /**
     * X√°o tr·ªôn th·ª© t·ª± c√°c ph·∫ßn t·ª≠ trong m·ªôt m·∫£ng (thu·∫≠t to√°n Fisher-Yates).
     */
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    // NEW: H√†m sao ch√©p Link ph√≤ng
    window.copyRoomLink = function() {
        const fullUrl = window.location.origin + window.location.pathname + `?room=${SESSION_ID}`;
        navigator.clipboard.writeText(fullUrl).then(() => {
            copyFeedbackEl.textContent = '‚úÖ ƒê√£ sao ch√©p ƒë∆∞·ªùng link ph√≤ng! G·ª≠i cho b·∫°n b√® c·ªßa b·∫°n.';
            copyFeedbackEl.classList.remove('opacity-0');
            setTimeout(() => { copyFeedbackEl.classList.add('opacity-0'); }, 3000);
        }).catch(err => {
            copyFeedbackEl.textContent = '‚ùå L·ªói sao ch√©p, vui l√≤ng sao ch√©p URL th·ªß c√¥ng.';
            copyFeedbackEl.classList.remove('opacity-0');
            setTimeout(() => { copyFeedbackEl.classList.add('opacity-0'); }, 3000);
        });
    };

    // NEW: H√†m t·∫°o ID ng·∫´u nhi√™n v√† chuy·ªÉn h∆∞·ªõng
    window.createAndRedirectToNewRoom = function() {
        // T·∫°o ID 6 k√Ω t·ª± ng·∫´u nhi√™n
        const newRoomId = 'room-' + Math.random().toString(36).substring(2, 8);
        // Chuy·ªÉn h∆∞·ªõng ng∆∞·ªùi d√πng ƒë·∫øn URL v·ªõi ID ph√≤ng m·ªõi
        window.location.href = window.location.origin + window.location.pathname + `?room=${newRoomId}`;
    };

    // NEW: H√†m tham gia ph√≤ng b·∫±ng ID
    window.joinRoomById = function() {
        const inputId = document.getElementById('join-room-input').value.trim();
        joinFeedbackEl.textContent = '';

        if (inputId.length < 5) {
            joinFeedbackEl.textContent = "ID ph√≤ng ph·∫£i c√≥ √≠t nh·∫•t 5 k√Ω t·ª±.";
            return;
        }

        // Chuy·ªÉn h∆∞·ªõng ƒë·∫øn ph√≤ng t∆∞∆°ng ·ª©ng
        window.location.href = window.location.origin + window.location.pathname + `?room=${inputId}`;
    };


    // --- FIREBASE LOGIC ---

    window.onAuthReady = function() {
        if (!window.db) {
             // Ch·∫°y ch·∫ø ƒë·ªô m√¥ ph·ªèng n·∫øu kh√¥ng c√≥ Firebase
             roomIdEl.textContent = DEFAULT_ROOM_ID;
             startButton.classList.remove('hidden'); 
             console.error("Firebase config not found. Running in simulated mode.");
             teamScreen.classList.remove('hidden');
             quizScreen.classList.add('hidden');
             return;
        }

        roomIdEl.textContent = SESSION_ID; 
        setupFirestoreListeners();
    }

    function getGameSessionRef() {
        if (!window.db || !window.appId) return null;
        // ƒê∆∞·ªùng d·∫´n: /artifacts/{appId}/public/data/geo_games/{SESSION_ID}
        return doc(window.db, "artifacts", window.appId, "public", "data", "geo_games", SESSION_ID);
    }
    
    // L·∫Øng nghe thay ƒë·ªïi tr·∫°ng th√°i game (Real-time)
    function setupFirestoreListeners() {
        const docRef = getGameSessionRef();
        if (!docRef) return;

        onSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
                currentGameState = docSnap.data();
                updateUI(currentGameState);
            } else {
                console.log(`Game session ${SESSION_ID} does not exist. Initializing...`);
                // N·∫øu ch∆∞a c√≥ session, cho ph√©p Admin (ng∆∞·ªùi ƒë·∫ßu ti√™n) kh·ªüi t·∫°o
                startButton.classList.remove('hidden');
                updateUI({ status: 'waiting', currentQuestionIndex: 0, teams: { teamA: { score: 0 }, teamB: { score: 0 } } });
            }
        }, (error) => {
            console.error("Error listening to game state:", error);
            feedbackMessageEl.textContent = "L·ªói k·∫øt n·ªëi: " + error.message;
        });
    }

    // KH·ªûI T·∫†O/ƒê·∫∂T L·∫†I GAME TRONG PH√íNG HI·ªÜN T·∫†I
    window.startGameInCurrentRoom = async function() {
        const docRef = getGameSessionRef();
        if (!docRef) return;
        
        // X√ÅO TR·ªòN C√ÇU H·ªéI M·ªöI
        const shuffledQuestions = [...questions];
        shuffleArray(shuffledQuestions); 

        try {
            await setDoc(docRef, {
                currentQuestionIndex: 0,
                status: 'in_progress',
                teams: {
                    teamA: { score: 0, lastAnswer: null },
                    teamB: { score: 0, lastAnswer: null }
                },
                answeredBy: null, // M·ªü kh√≥a c√¢u h·ªèi
                totalQuestions: questions.length,
                shuffledQuestions: shuffledQuestions, // L∆ØU DANH S√ÅCH C√ÇU H·ªéI ƒê√É X√ÅO TR·ªòN
            });
            console.log(`Game session ${SESSION_ID} reset successfully.`);
        } catch (e) {
            console.error("Error resetting game:", e);
        }
    }

    // C·∫≠p nh·∫≠t ƒëi·ªÉm v√† th√¥ng b√°o ƒë·ªôi ƒë√£ tr·∫£ l·ªùi (Ch·ªâ g·ªçi khi tr·∫£ l·ªùi ƒë√∫ng)
    async function updateScoreAndNext(teamId, questionIndex, isCorrect) {
        const docRef = getGameSessionRef();
        if (!docRef || currentGameState.answeredBy) return; 

        if (isCorrect) {
            const updatePayload = {
                answeredBy: teamId, 
                [`teams.${teamId}.score`]: currentGameState.teams[teamId].score + 1
            };
            
            try {
                await updateDoc(docRef, updatePayload);
            } catch (e) {
                console.error("Error updating score:", e);
            }
        }
    }

    // Chuy·ªÉn sang c√¢u h·ªèi ti·∫øp theo
    window.nextQuestion = async function() {
        const docRef = getGameSessionRef();
        if (!docRef || currentGameState.status !== 'in_progress') return;

        const nextIndex = currentGameState.currentQuestionIndex + 1;

        if (nextIndex >= questions.length) {
             // K·∫øt th√∫c game
            await updateDoc(docRef, { status: 'finished' });
        } else {
            // Chuy·ªÉn c√¢u h·ªèi
            await updateDoc(docRef, {
                currentQuestionIndex: nextIndex,
                answeredBy: null, // M·ªü kh√≥a c√¢u h·ªèi m·ªõi
                'teams.teamA.lastAnswer': null, 
                'teams.teamB.lastAnswer': null 
            });
        }
    }

    // --- GAME UI & LOGIC ---

    // H√†m c·∫≠p nh·∫≠t giao di·ªán d·ª±a tr√™n tr·∫°ng th√°i Firestore
    function updateUI(state) {
        if (!state || !state.status) {
            teamScreen.classList.remove('hidden');
            quizScreen.classList.add('hidden');
            endScreen.classList.add('hidden');
            return;
        }

        totalQuestionsEl.textContent = questions.length;
        scoreTeamAEl.textContent = state.teams.teamA.score;
        scoreTeamBEl.textContent = state.teams.teamB.score;

        if (state.status === 'waiting') {
            teamScreen.classList.remove('hidden');
            quizScreen.classList.add('hidden');
            endScreen.classList.add('hidden');
        } else if (state.status === 'in_progress') {
            teamScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            endScreen.classList.add('hidden');
            
            // X·ª≠ l√Ω c√¢u h·ªèi
            if (state.shuffledQuestions && state.currentQuestionIndex < state.shuffledQuestions.length) {
                loadQuestion(state);
            } else {
                 showEndScreen(state);
            }
        } else if (state.status === 'finished') {
            showEndScreen(state);
        }
        
        // C·∫≠p nh·∫≠t n√∫t "Ti·∫øp t·ª•c"
        const isAnswered = state.answeredBy !== null;
        nextButton.disabled = !isAnswered;
        
        // Lu√¥n hi·ªÉn th·ªã n√∫t Admin ƒë·ªÉ ng∆∞·ªùi t·∫°o ph√≤ng c√≥ th·ªÉ kh·ªüi ƒë·ªông game b·∫•t c·ª© l√∫c n√†o
        startButton.classList.remove('hidden'); 
    }
    
    window.joinTeam = function(teamId) {
        myTeamId = teamId;
        console.log("Joined team:", myTeamId);
        // Sau khi join team, ·∫©n team screen v√† ch·ªù tr·∫°ng th√°i game
        teamScreen.classList.add('hidden');
        quizScreen.classList.remove('hidden');
    }

    function loadQuestion(state) {
        const index = state.currentQuestionIndex;
        const q = state.shuffledQuestions[index]; 
        const answeredTeamId = state.answeredBy;

        questionIndexEl.textContent = index + 1;
        feedbackMessageEl.innerHTML = '';

        questionTextEl.innerHTML = `<span class="text-sm font-normal text-green-600">(${q.topic})</span><br>${index + 1}. ${q.question}`;
        optionsContainer.innerHTML = ''; 

        const shuffledOptions = [...q.options];

        // T·∫°o c√°c n√∫t ƒë√°p √°n
        shuffledOptions.forEach(option => {
            const button = document.createElement('button');
            button.className = 'option-button w-full py-3 rounded-xl border-2 border-green-500 bg-white hover:bg-green-100 font-medium text-gray-800 shadow-md';
            button.textContent = option;
            button.onclick = () => checkAnswer(button, option, q.answer, index);
            optionsContainer.appendChild(button);
        });

        // X·ª≠ l√Ω tr·∫°ng th√°i c√¢u h·ªèi ƒë√£ ƒë∆∞·ª£c tr·∫£ l·ªùi
        if (answeredTeamId) {
            // V√¥ hi·ªáu h√≥a t·∫•t c·∫£ c√°c n√∫t
            Array.from(optionsContainer.children).forEach(btn => {
                btn.classList.add('disabled');
            });

            const correctButton = Array.from(optionsContainer.children).find(btn => btn.textContent === q.answer);
            if (correctButton) {
                correctButton.classList.add('correct');
            }
            
            const teamName = answeredTeamId === 'teamA' ? 'Xanh üîµ' : 'V√†ng üü°';
            answeringTeamNameEl.textContent = teamName;
            answeredByTeamEl.classList.remove('hidden');
            feedbackMessageEl.innerHTML = `<span class="text-green-600">‚úÖ ƒê·ªôi ${teamName} ƒë√£ tr·∫£ l·ªùi ƒë√∫ng!</span>`;
            
        } else {
            // C√¢u h·ªèi m·ªõi, cho ph√©p tr·∫£ l·ªùi
            answeredByTeamEl.classList.add('hidden');
        }
    }

    // H√†m ki·ªÉm tra ƒë√°p √°n (ch·ªâ ƒë∆∞·ª£c g·ªçi n·∫øu answeredBy l√† null)
    function checkAnswer(selectedButton, selectedOption, correctAnswer, questionIndex) {
        if (!myTeamId || currentGameState.answeredBy !== null || currentGameState.currentQuestionIndex !== questionIndex) {
            return;
        }
        
        // V√¥ hi·ªáu h√≥a n√∫t c·ª•c b·ªô ƒë·ªÉ tr√°nh b·∫•m li√™n t·ª•c
        Array.from(optionsContainer.children).forEach(btn => {
            btn.classList.add('disabled');
        });

        const isCorrect = selectedOption === correctAnswer;

        if (isCorrect) {
            selectedButton.classList.add('correct');
            feedbackMessageEl.innerHTML = `<span class="text-green-600">üéâ B·∫°n ƒë√£ gi√†nh quy·ªÅn tr·∫£ l·ªùi ƒë√∫ng cho ƒê·ªôi ${myTeamId === 'teamA' ? 'Xanh' : 'V√†ng'}!</span>`;
            updateScoreAndNext(myTeamId, questionIndex, true); 
            showBonusGame(myTeamId); 
        } else {
            selectedButton.classList.add('incorrect');
            feedbackMessageEl.innerHTML = '<span class="text-red-600">‚ùå Sai r·ªìi! Ch·ªù ƒë·ªìng ƒë·ªôi ho·∫∑c ƒë·ªëi th·ªß tr·∫£ l·ªùi.</span>';
            
            // T√¨m v√† l√†m n·ªïi b·∫≠t ƒë√°p √°n ƒë√∫ng sau 1 gi√¢y
            setTimeout(() => {
                Array.from(optionsContainer.children).forEach(btn => {
                    if (btn.textContent === correctAnswer) {
                        btn.classList.add('correct');
                    }
                });
            }, 1000);
        }
    }
    
    function showEndScreen(state) {
        quizScreen.classList.add('hidden');
        endScreen.classList.remove('hidden');
        
        const scoreA = state.teams.teamA.score;
        const scoreB = state.teams.teamB.score;
        
        let winningTeamName = '';
        let message = '';

        if (scoreA > scoreB) {
            winningTeamName = 'Xanh üîµ';
            message = 'ƒê·ªôi Xanh ƒë√£ th·ªÉ hi·ªán s·ª± h·ª£p t√°c tuy·ªát v·ªùi v√† gi√†nh chi·∫øn th·∫Øng chung cu·ªôc!';
        } else if (scoreB > scoreA) {
            winningTeamName = 'V√†ng üü°';
            message = 'ƒê·ªôi V√†ng ƒë√£ ch·ª©ng t·ªè ki·∫øn th·ª©c v·ªØng v√†ng v√† gi√†nh ƒë∆∞·ª£c vinh quang!';
        } else {
            winningTeamName = 'H√íA';
            message = 'C·∫£ hai ƒë·ªôi ƒë·ªÅu ngang t√†i ngang s·ª©c! Tuy·ªát v·ªùi!';
        }

        winningTeamEl.textContent = winningTeamName;
        resultMessageEl.textContent = message;
    }

    // --- LOGIC CHO MINI GAME ƒê·ªíNG ƒê·ªòI ---

    function showBonusGame(teamId) {
        if (bonusGameActive) return;
        bonusGameActive = true;
        
        bonusGameEl.style.display = 'flex';
        bonusStarCount = 0; 
        
        const itemSymbol = ['üí∞', 'üíé', '‚≠ê', '‚ú®']; 
        const items = [];
        const numItems = 15; 
        const duration = 3000; 

        const bonusGameContainer = bonusGameEl.querySelector('div');
        const teamColor = teamId === 'teamA' ? 'XANH' : 'V√ÄNG';
        bonusGameContainer.innerHTML = `<h3 class="text-3xl font-bold text-yellow-700 mb-4">‚≠ê TH∆Ø·ªûNG ƒêI·ªÇM ƒê·ªòI ${teamColor}! ‚≠ê</h3><p class="text-lg text-gray-700">Nhanh tay b·∫•m v√†o ƒë·ªÉ nh·∫≠n th√™m ƒëi·ªÉm th∆∞·ªüng cho ƒë·ªôi!</p>`;


        for (let i = 0; i < numItems; i++) {
            const item = document.createElement('div');
            item.className = 'star';
            item.textContent = itemSymbol[Math.floor(Math.random() * itemSymbol.length)];
            
            const startX = Math.random() * window.innerWidth;
            item.style.left = `${startX}px`;
            
            const fallTime = 1.5 + Math.random() * 1.5;
            const delay = Math.random() * 0.5;

            item.style.animationName = 'fall';
            item.style.animationDuration = `${fallTime}s`;
            item.style.animationDelay = `${delay}s`;

            item.onclick = (e) => {
                e.stopPropagation();
                if (bonusGameActive) {
                    item.textContent = '‚úÖ';
                    item.style.color = '#34d399';
                    item.style.pointerEvents = 'none';
                    bonusStarCount++;
                    
                    if (teamId === 'teamA') {
                        scoreTeamAEl.textContent = parseInt(scoreTeamAEl.textContent) + 1;
                    } else {
                        scoreTeamBEl.textContent = parseInt(scoreTeamBEl.textContent) + 1;
                    }
                }
            };

            bonusGameEl.appendChild(item);
            items.push(item);
        }

        // ƒê·∫∑t timeout ƒë·ªÉ k·∫øt th√∫c mini-game
        setTimeout(() => {
            endBonusGame(items, teamId);
        }, duration + 500);
    }

    async function endBonusGame(items, teamId) {
        bonusGameActive = false;
        
        // C·ªông ƒëi·ªÉm th∆∞·ªüng ch√≠nh th·ª©c v√†o Firebase
        if (bonusStarCount > 0) {
            const docRef = getGameSessionRef();
            if (docRef) {
                await updateDoc(docRef, {
                    [`teams.${teamId}.score`]: currentGameState.teams[teamId].score + bonusStarCount
                });
            }
        }

        // D·ªçn d·∫πp
        items.forEach(item => item.remove());
        bonusGameEl.style.display = 'none';
        bonusStarCount = 0;
        
        if (currentGameState.answeredBy) {
            nextButton.disabled = false;
        }
    }

</script>